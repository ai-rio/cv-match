#!/usr/bin/env sh

echo "🧪 Running full test suite before push..."

# Frontend tests
if [ -d "frontend" ]; then
    echo "⚛️ Running frontend tests..."
    cd frontend
    if [ -f "package.json" ] && grep -q "test" package.json; then
        bunx test:coverage || {
            echo "❌ Frontend tests failed"
            exit 1
        }
    else
        echo "⚠️ No frontend tests configured"
    fi
    cd ..
fi

# Backend tests
if [ -d "backend" ]; then
    echo "🐍 Running backend tests..."
    cd backend
    if [ -f "pyproject.toml" ]; then
        # Check if pytest is configured
        if grep -q "pytest" pyproject.toml || [ -d "tests" ]; then
            uv run pytest --cov=app --cov-report=term-missing || {
                echo "❌ Backend tests failed"
                exit 1
            }
        else
            echo "⚠️ No backend tests configured (no pytest or tests/ directory)"
        fi
    else
        echo "⚠️ Backend pyproject.toml not found"
    fi
    cd ..
fi

# TypeScript type checking for frontend
if [ -d "frontend" ]; then
    echo "📝 Running TypeScript type checking..."
    cd frontend
    bunx type-check || {
        echo "❌ TypeScript type checking failed"
        exit 1
    }
    cd ..
fi

# Build check (dry run)
echo "🏗️ Running build checks..."

# Frontend build check
if [ -d "frontend" ]; then
    cd frontend
    echo "Checking frontend build..."
    bunx build || {
        echo "❌ Frontend build failed"
        exit 1
    }
    cd ..
fi

# Security audit for dependencies
echo "🔐 Running security audit..."

# Frontend audit
if [ -d "frontend" ]; then
    cd frontend
    echo "Checking frontend dependencies for vulnerabilities..."
    bun audit || {
        echo "⚠️ Frontend has security vulnerabilities. Consider fixing before production."
        # Don't fail the push, just warn
    }
    cd ..
fi

echo "✅ All pre-push checks passed!"
echo "🚀 Ready to push to remote repository!"