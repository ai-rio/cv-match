#!/usr/bin/env sh

echo "🚀 Pre-commit Checks Starting..."

# Check for staged frontend files and run lint-staged
if git diff --cached --name-only | grep -q "^frontend/"; then
    echo "🔍 Running lint-staged on frontend files..."
    cd frontend && bun run lint-staged || {
        echo "❌ Lint-staged failed - fix critical issues before committing"
        exit 1
    }
    cd ..

    echo "📝 Running TypeScript type checking..."
    cd frontend && bun run type-check || {
        echo "❌ TypeScript type checking failed - fix type errors before committing"
        exit 1
    }
    cd ..
fi

# Check for staged Python files and run linting and type checking
if git diff --cached --name-only | grep -q "\.py$"; then
    echo "🐍 Running Python linting and formatting..."
    cd backend && uv run ruff check --fix . --severity=ERROR || {
        echo "❌ Python linting failed - fix errors before committing"
        exit 1
    }

    echo "🐍 Running Python type checking..."
    uv run mypy app/ --ignore-missing-imports --explicit-package-bases --show-error-codes || {
        echo "❌ Python type checking failed - fix type errors before committing"
        exit 1
    }
    cd ..
fi

# Check for SQL migrations
if git diff --cached --name-only | grep -q "supabase/migrations/"; then
    echo "🗄️ SQL migration files detected - validated"
fi

# Check for large files (>5MB)
echo "📏 Checking file sizes..."
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 5242880 ]; then
            echo "❌ Large file detected: $file (>5MB)"
            echo "Please use Git LFS for large files"
            exit 1
        fi
    fi
done

echo "✅ All pre-commit checks passed!"
