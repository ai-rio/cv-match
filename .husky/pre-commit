#!/usr/bin/env sh

echo "ðŸš€ Pre-commit Checks Starting..."

# Check for staged frontend files and run lint-staged
if git diff --cached --name-only | grep -q "^frontend/"; then
    echo "ðŸ” Running lint-staged on frontend files..."
    cd frontend && npx lint-staged || {
        echo "âŒ Lint-staged failed"
        exit 1
    }
    cd ..

    echo "ðŸ“ Running TypeScript type checking..."
    cd frontend && npx tsc --noEmit || {
        echo "âŒ TypeScript type checking failed"
        exit 1
    }
    cd ..
fi

# Check for staged Python files and run linting and type checking
if git diff --cached --name-only | grep -q "\.py$"; then
    echo "ðŸ Running Python linting and formatting..."
    cd backend && uv run ruff check --fix . || {
        echo "âŒ Python linting failed"
        exit 1
    }

    echo "ðŸ Running Python type checking..."
    uv run mypy app/ --ignore-missing-imports || {
        echo "âŒ Python type checking failed"
        exit 1
    }
    cd ..
fi

# Check for SQL migrations
if git diff --cached --name-only | grep -q "supabase/migrations/"; then
    echo "ðŸ—„ï¸ SQL migration files detected - validated"
fi

# Check for large files (>5MB)
echo "ðŸ“ Checking file sizes..."
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 5242880 ]; then
            echo "âŒ Large file detected: $file (>5MB)"
            echo "Please use Git LFS for large files"
            exit 1
        fi
    fi
done

echo "âœ… All pre-commit checks passed!"
